<!DOCTYPE html>
<html>
<head>
    <title>&lt;/&gt; htmx Realtime Test Server</title>
    <link rel="stylesheet" href="/stylesheet.css" />
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx-ext-ws@2.0.2" integrity="sha384-932iIqjARv+Gy0+r6RTGrfCkCKS5MsF539Iqf6Vt8L4YmbnnWI2DSFoMD90bvXd0" crossorigin="anonymous"></script>
    <script type="module" defer>
    import { CodeJar } from "https://esm.sh/codejar@4";
    const editor = document.getElementById('editor');
    const jar = CodeJar(editor, highlight);
    window.addEventListener('DOMContentLoaded', (event) => {
        document.body.addEventListener('htmx:wsConfigSend', (evt) => {
            evt.detail.parameters['params'] = JSON.parse(evt.detail.parameters['params']);
        });
        document.body.addEventListener('htmx:wsAfterMessage', (evt) => {
            const out = JSON.stringify(JSON.parse(evt.detail.message), null, 2);
            const details = document.createElement("details");
            const summary = document.createElement("summary");
            summary.textContent = "Received at " + new Date().toLocaleTimeString();
            const pre = document.createElement("pre");
            const code = document.createElement("code");
            pre.className = "code";
            pre.textContent = out;

            details.appendChild(summary);
            details.appendChild(pre);

            document.getElementById("ws-output").appendChild(details);
            evt.preventDefault();
        });
    });
    </script>
</head>
<body>
<main>
<h1 id="header">Regal LSP Websocket connectivity test</h1>

<div class="elastic container" hx-ext="ws" ws-connect="/regal" ws-target="#ws-output">
    <div id="editor"/>

    <form ws-send="">
        <h3>initialize</h3>
        <div>
            <input name="jsonrpc" type="hidden" style="width:500px;" value="2.0"/>
            <input name="id" type="hidden" style="width:500px;" value="0"/>
            <input name="method" type="hidden" style="width:500px;" value="initialize"/>
            <textarea name="params" style="width:500px;">{
  "capabilities": {
    "textDocument": {
      "hover": {
        "dynamicRegistration": true,
        "contentFormat": [
          "markdown",
          "plaintext"
        ]
      },
      "moniker": {},
      "synchronization": {
        "dynamicRegistration": true,
        "willSave": false,
        "didSave": false,
        "willSaveWaitUntil": false
      },
      "codeAction": {
        "dynamicRegistration": true,
        "codeActionLiteralSupport": {
          "codeActionKind": {
            "valueSet": [
              "",
              "quickfix",
              "source",
              "source.organizeImports"
            ]
          }
        },
        "resolveSupport": {
          "properties": [
            "edit"
          ]
        }
      },
      "completion": {
        "dynamicRegistration": true,
        "completionItem": {
          "snippetSupport": true,
          "commitCharactersSupport": true,
          "documentationFormat": [
            "markdown",
            "plaintext"
          ],
          "deprecatedSupport": false,
          "preselectSupport": false
        },
        "contextSupport": false
      },
      "signatureHelp": {
        "dynamicRegistration": true,
        "signatureInformation": {
          "documentationFormat": [
            "markdown",
            "plaintext"
          ]
        }
      },
      "declaration": {
        "dynamicRegistration": true,
        "linkSupport": true
      },
      "definition": {
        "dynamicRegistration": true,
        "linkSupport": true
      },
      "typeDefinition": {
        "dynamicRegistration": true,
        "linkSupport": true
      },
      "implementation": {
        "dynamicRegistration": true,
        "linkSupport": true
      },
      "rename": {
        "dynamicRegistration": true,
        "prepareSupport": true
      }
    },
    "workspace": {
      "didChangeConfiguration": {
        "dynamicRegistration": true
      }
    }
  },
  "processId": null,
  "rootUri": "file://.",
  "workspaceFolders": null
}</textarea>
            <input type="submit" value="Send" class="btn primary"/>
        </div>
    </form>
    <br/>
    <form ws-send="">
        <h3>textDocument/didOpen</h3>
        <!-- {"jsonrpc":"2.0","method":"","params":{}}	-->
        <div>
            <input name="jsonrpc" type="hidden" style="width:500px;" value="2.0"/>
            <input name="id" type="hidden" style="width:500px;" value="0"/>
            <input name="method" type="hidden" style="width:500px;" value="textDocument/didOpen"/>
            <textarea name="params" style="width:500px;">{
  "textDocument": {
    "uri": "file://t/policy.rego",
    "languageId": "rego",
    "text": "package auth\n\ndefault allow := false\nallow if input.foo\n",
    "version": 0
  }
}</textarea>
            <input type="submit" value="Send" class="btn primary"/>
        </div>
    </form>
    <br/>
    <h3>Receive a Message</h3>
    <div id="ws-output"/>
</div>
</main>
</body>
